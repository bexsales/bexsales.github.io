import{g as me,k as ye,h as ge,T as p,M as be,r as s,i as fe,a as _e,j as e,_ as V,b as Ce,f as ve,x as _,P,S as L,C as O,D as H,y as q,z as D,G as Se,A as w,N as Te,W as Oe}from"./index-CRnpIGc-.js";import{P as Pe,C as qe}from"./product-view-DiewDh5b.js";import{D as F,a as W,b as $,c as A,G as S}from"./Grid-DpAbMRiI.js";import{F as X,T,L as De}from"./LoadingButton-B7TTRkv-.js";import{C as we}from"./customer-view-Q2IZrRN-.js";import{d as Le,e as Fe,b as We,T as G,a as u,f as $e}from"./search-fill-Db4WrSMl.js";import{C as Ae}from"./Container-Dvtg-Kkc.js";import{C as Re}from"./Card-BTqcAt5G.js";import{u as ke}from"./use-auth-DBsn9flL.js";import"./Select-BteqBgEO.js";import"./isMuiElement-BgZib9pl.js";function Ue(a){return me("MuiDialogContentText",a)}ye("MuiDialogContentText",["root"]);const Me=["children","className"],Ne=a=>{const{classes:i}=a,h=ve({root:["root"]},Ue,i);return V({},i,h)},Be=ge(p,{shouldForwardProp:a=>be(a)||a==="classes",name:"MuiDialogContentText",slot:"Root",overridesResolver:(a,i)=>i.root})({}),ze=s.forwardRef(function(i,d){const h=fe({props:i,name:"MuiDialogContentText"}),{className:c}=h,g=_e(h,Me),b=Ne(g);return e.jsx(Be,V({component:"p",variant:"body1",color:"text.secondary",ref:d,ownerState:g,className:Ce(b.root,c)},h,{classes:b}))}),Ee=ze;function J({onSelect:a}){const[i,d]=s.useState(!1),h=()=>{d(!0)},c=()=>{d(!1)},g=b=>{a(b),c()};return e.jsxs("div",{children:[e.jsx(_,{variant:"outlined",onClick:h,children:"Add Product"}),e.jsxs(F,{open:i,onClose:c,maxWidth:"xl",fullWidth:!0,children:[e.jsx(W,{children:"Products"}),e.jsx($,{children:e.jsx(X,{sx:{width:"100%"},children:e.jsx(Pe,{onSelect:g,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(_,{onClick:c,color:"primary",children:"Close"})})]})]})}J.propTypes={onSelect:P.func};function K({onSelect:a}){const[i,d]=s.useState(!1),h=()=>{d(!0)},c=()=>{d(!1)},g=b=>{a(b),c()};return e.jsxs("div",{children:[e.jsx(_,{variant:"outlined",onClick:h,children:"Set"}),e.jsxs(F,{open:i,onClose:c,maxWidth:"xl",fullWidth:!0,children:[e.jsx(W,{children:"Customers"}),e.jsx($,{sx:{padding:0},children:e.jsx(X,{sx:{width:"100%"},children:e.jsx(we,{onSelect:g,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(_,{onClick:c,color:"primary",children:"Close"})})]})]})}K.propTypes={onSelect:P.func};function Y({handleCancelOrder:a}){const[i,d]=s.useState(!1),h=()=>{d(!0)},c=()=>{d(!1)};return e.jsxs(L,{direction:"row",alignItems:"center",children:[e.jsx(p,{variant:"body1",sx:{color:"red"},children:"Cancel"}),e.jsxs(O,{onClick:h,sx:{color:"red"},children:[e.jsx(H,{icon:"eva:close-outline"})," "]}),e.jsxs(F,{open:i,onClose:c,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[e.jsx(W,{id:"alert-dialog-title",children:"Confirm Cancellation"}),e.jsx($,{children:e.jsx(Ee,{id:"alert-dialog-description",children:"Are you sure you want to cancel this order?"})}),e.jsxs(A,{children:[e.jsx(_,{onClick:c,color:"primary",children:"Cancel"}),e.jsx(_,{onClick:a,color:"primary",autoFocus:!0,children:"Confirm"})]})]})]})}Y.propTypes={handleCancelOrder:P.func};function Z({orderId:a}){const[i,d]=s.useState(!1),[h,c]=s.useState(""),[g,b]=s.useState(""),[x,R]=s.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[m,C]=s.useState([]),[k,ee]=s.useState([]),[U,te]=s.useState({}),[oe,M]=s.useState(0),[re,N]=s.useState(0),[ae,se]=s.useState(0),[B,z]=s.useState(""),[E,I]=s.useState("");s.useEffect(()=>{he()},[]);const ne=()=>{Q(!0)},le=(t,o)=>{console.log("Fetching order totals");const n=`${w.baseURL}/api-proxy/proxy?method=post&resource=ordertotals`;console.log(n);const r=m.map(l=>({product_id:l[2].id,product_uom_qty:l[2].product_uom_qty})),y={partner_id:x.id,order_line:r};console.log("Request body",y),q.post(n,y,{headers:{Authorization:`Bearer ${D.get("jwt")}`}}).then(l=>{console.log(l.data),te(l.data.result.product_prices),M(l.data.result.subtotal),N(l.data.result.total)}).catch(l=>{console.error("Error fetching order totals:",l)})};s.useEffect(()=>{le();const t=m.reduce((o,n)=>o+n[2].product_uom_qty,0);se(t)},[x,m]);const ie=t=>{z(t.target.value)},de=t=>{I(t.target.value)},Q=t=>{d(!0),console.log("Saving Order");let o="post";t===!0&&(o="cancel");const n=`${w.baseURL}/api-proxy/proxy?method=${o}&resource=orders`;console.log(n),console.log(m);const r=m.map(j=>[j[0],j[1],{product_id:j[2].id,product_uom_qty:j[2].product_uom_qty}]),y=k.map(j=>[2,j[1],{}]),l=r.concat(y),f={order:{id:parseInt(a,10),partner_id:x.id,order_line:l,x_studio_notes:B,client_order_ref:E}};console.log("Request body",f),q.post(n,f,{headers:{Authorization:`Bearer ${D.get("jwt")}`}}).then(j=>{console.log(j.data),d(!1),j.data.result.success===!1?alert(j.data.result.message):window.location.reload()}).catch(j=>{console.error("Error saving order:",j)})},ce=(t,o,n)=>{if(t<0||t>=m.length)return;const r=m.filter((l,f)=>f===t);r[0][0]!==0&&(console.log("Adding line to delete queue",r),ee(k.concat(r)));const y=m.filter((l,f)=>f!==t);C(y)},ue=(t,o)=>{const n=m.map((r,y)=>{if(y===t){console.log("handle qty change",r);const l=["consu","service"];return r[2].qty_available<o&&!l.includes(r[2].type)?(alert("Quantity available is insufficient."),r):[r[0],r[1],{...r[2],product_uom_qty:o!==0?Number(o):0}]}return r});C(n)},v=t=>t?`$${t.toFixed(2)}`:"",he=()=>{console.log("Fetching Order Details");const t=`${w.baseURL}/api-proxy/proxy?method=get&resource=orders&order_id=${a}`;console.log(t),q.get(t,{headers:{Authorization:`Bearer ${D.get("jwt")}`}}).then(o=>{console.log(o.data.data),c(o.data.data.name),R(o.data.data.customer_id),z(o.data.data.x_studio_notes),I(o.data.data.client_order_ref?o.data.data.client_order_ref:"");const n=o.data.data.order_line.map(r=>[1,r.id,{line_id:r.id,id:r.product_id.id,name:r.name,product_uom_qty:r.product_uom_qty,attributes:r.product_id.attributes.map(y=>`${y.attribute}:${y.name}`),qty_available:r.product_id.qty_available,type:r.product_id.type}]);console.log(n),C(n),M(o.data.data.amount_untaxed),N(o.data.data.amount_total),b(o.data.data.state)}).catch(o=>{console.error("Error fetching order details:",o)})},xe=t=>{console.log("Setting order partner"),console.log(t),R({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email})},pe=t=>{console.log("Adding order line"),console.log(t);const o=["consu","service"];t.qty_available<1&&!o.includes(t.type)?alert("Cannot add product lines with 0 qty available"):C([...m,[0,0,{id:t.id,name:`[${t.default_code}] ${t.name}`,product_uom_qty:1,attributes:t.attributes,qty_available:t.qty_available}]])},je=e.jsxs(e.Fragment,{children:[e.jsx(L,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(T,{fullWidth:!0,name:"partner_id",label:"Customer",value:x.name,InputProps:{readOnly:!0,endAdornment:e.jsx(O,{children:e.jsx(K,{onSelect:xe})})}})}),x.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(p,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(p,{variant:"body1",children:x.street}),e.jsxs(p,{variant:"body1",children:[x.city," ",x.state]}),e.jsxs(p,{variant:"body1",children:[x.country," ",x.zip]}),e.jsxs(p,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",x.phone]}),e.jsxs(p,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",x.mobile]}),e.jsxs(p,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",x.email]})]}),e.jsx(O,{children:e.jsx(J,{onSelect:pe})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Le,{component:Se,children:e.jsxs(Fe,{children:[e.jsx(We,{children:e.jsxs(G,{children:[e.jsx(u,{children:"Product"}),e.jsx(u,{children:"Attributes"}),e.jsx(u,{children:"Unit Price"}),e.jsx(u,{children:"Qty Available"}),e.jsx(u,{children:"Qty"}),e.jsx(u,{children:"Subtotal"}),e.jsx(u,{})]})}),e.jsx($e,{children:m.map((t,o)=>e.jsxs(G,{children:[e.jsx(u,{children:t[2].name}),e.jsx(u,{children:t[2].attributes.map((n,r)=>e.jsx(qe,{label:n,variant:"outlined"},r))}),e.jsx(u,{children:v(U[t[2].id])}),e.jsx(u,{children:t[2].qty_available}),e.jsx(u,{children:e.jsx(T,{type:"number",style:{minWidth:"100px"},value:t[2].product_uom_qty!==0?t[2].product_uom_qty:"",onChange:n=>ue(o,n.target.value)})}),e.jsx(u,{children:v(U[t[2].id]*t[2].product_uom_qty)}),e.jsx(u,{align:"right",children:e.jsx(O,{onClick:()=>ce(o),children:e.jsx(H,{icon:"eva:trash-2-outline"})})})]},o))})]})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsxs(p,{variant:"body1",fontWeight:"bold",children:["Total Product Qty: ",ae]}),e.jsxs(p,{variant:"body1",fontWeight:"bold",children:["Subtotal: ",v(oe)]}),e.jsxs(p,{variant:"body1",fontWeight:"bold",children:["Total: ",v(re)]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(S,{container:!0,spacing:2,children:e.jsx(S,{item:!0,xs:12,md:6,lg:6,children:e.jsx(T,{label:"Notes",value:B,multiline:!0,fullWidth:!0,rows:4,onChange:ie})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(S,{container:!0,spacing:2,children:e.jsx(S,{item:!0,xs:12,md:6,lg:6,children:e.jsx(T,{label:"PO Number",value:E,fullWidth:!0,onChange:de})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(De,{fullWidth:!0,size:"large",type:"submit",variant:"contained",color:"inherit",onClick:Q,loading:i,children:"Save"})]});return e.jsxs(Ae,{children:[e.jsxs(L,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:5,children:[e.jsxs(p,{variant:"h4",children:["Order ",h," [",g,"]"]}),g==="draft"&&e.jsx(Y,{handleCancelOrder:ne})]}),je,e.jsx(Re,{})]})}Z.propTypes={orderId:P.any};function tt(){ke();const{orderId:a}=Te();return e.jsxs(e.Fragment,{children:[e.jsx(Oe,{children:e.jsx("title",{children:" Order Detail | BEX Sales "})}),e.jsx(Z,{orderId:a})]})}export{tt as default};
