import{r as d,j as e,D as f,P as S,C as be,S as D,H as _,T as i,V as ve,J as _e,E as R,F as z,G as L,W as Ce}from"./index-BiFuz3rn.js";import{D as O,a as q,b as k,P as Se,c as A}from"./product-template-view-Ds6GB-xq.js";import{F as W,T as C}from"./TextField-CEWYcRfQ.js";import{C as G}from"./customer-view-CKq2pkbK.js";import{P as Pe}from"./product-view-aMh5q7P1.js";import{e as Te,f as we,b as Oe,T as Q,a as h,g as qe}from"./search-fill-CroszyQg.js";import{C as ke}from"./Chip-mcDs6DVW.js";import{G as w}from"./Grid-Cc_kYYsE.js";import{L as Ae}from"./LoadingButton-CQpwfGuh.js";import{C as We}from"./Container-DbbtiuI8.js";import{C as Fe}from"./Card-rz0eWA_E.js";import{u as Ue}from"./use-auth-aK2ox_U1.js";import"./Select-BSvtViZa.js";import"./isMuiElement-s2B93Rdk.js";function K({onSelect:y}){const[j,p]=d.useState(!1),o=()=>{p(!0)},u=()=>{p(!1)},l=g=>{y(g),u()};return e.jsxs("div",{children:[e.jsx(f,{variant:"outlined",onClick:o,children:"Add Product"}),e.jsxs(O,{open:j,onClose:u,maxWidth:"xl",fullWidth:!0,children:[e.jsx(q,{children:"Products"}),e.jsx(k,{children:e.jsx(W,{sx:{width:"100%"},children:e.jsx(Se,{onSelect:l,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(f,{onClick:u,color:"primary",children:"Close"})})]})]})}K.propTypes={onSelect:S.func};function H({onSelect:y}){const[j,p]=d.useState(!1),o=()=>{p(!0)},u=()=>{p(!1)},l=g=>{y(g),u()};return e.jsxs("div",{children:[e.jsx(f,{variant:"outlined",onClick:o,children:"Set"}),e.jsxs(O,{open:j,onClose:u,maxWidth:"xl",fullWidth:!0,children:[e.jsx(q,{children:"Customers"}),e.jsx(k,{sx:{padding:0},children:e.jsx(W,{sx:{width:"100%"},children:e.jsx(G,{onSelect:l,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(f,{onClick:u,color:"primary",children:"Close"})})]})]})}H.propTypes={onSelect:S.func};function J({onSelect:y,filterParentContactOption:j}){const[p,o]=d.useState(!1),u=()=>{o(!0)},l=()=>{o(!1)},g=x=>{y(x),l()};return d.useEffect(()=>{console.log("DeliveryPopupModal Props:"),console.log("filterParentContactOption:",j)},[y,j]),e.jsxs("div",{children:[e.jsx(f,{variant:"outlined",onClick:u,children:"Set"}),e.jsxs(O,{open:p,onClose:l,maxWidth:"xl",fullWidth:!0,children:[e.jsx(q,{children:"Delivery Address"}),e.jsx(k,{sx:{padding:0},children:e.jsx(W,{sx:{width:"100%"},children:e.jsx(G,{onSelect:g,filterTypeOption:"delivery",filterParentContactOption:j,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(f,{onClick:l,color:"primary",children:"Close"})})]})]})}J.propTypes={onSelect:S.func,filterParentContactOption:S.number};function X({onSelect:y}){const[j,p]=d.useState(!1),o=()=>{p(!0)},u=()=>{p(!1)},l=g=>{y([g]),u()};return e.jsxs("div",{children:[e.jsx(f,{variant:"outlined",onClick:o,children:"Add SKU"}),e.jsxs(O,{open:j,onClose:u,maxWidth:"xl",fullWidth:!0,children:[e.jsx(q,{children:"Products"}),e.jsx(k,{children:e.jsx(W,{sx:{width:"100%"},children:e.jsx(Pe,{onSelect:l,style:{width:"100%"}})})}),e.jsx(A,{children:e.jsx(f,{onClick:u,color:"primary",children:"Close"})})]})]})}X.propTypes={onSelect:S.func};function $e(){const y=be(),[j,p]=d.useState(!1),[o,u]=d.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[l,g]=d.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[x,F]=d.useState([]),[E,Y]=d.useState({}),[Z,ee]=d.useState(0),[te,re]=d.useState(0),[ne,oe]=d.useState(0),[B,se]=d.useState(""),[M,le]=d.useState(""),[N,ae]=d.useState(""),I=new FileReader,V=d.useRef(null);function ie(t,s=","){let r=t.slice(0,t.indexOf(`
`)).split(s);return r=r.map(a=>a.replace(`
`,"").replace("\r","")),t.slice(t.indexOf(`
`)+1).split(`
`).map(a=>{const v=a.split(s).map(m=>m.replace(`
`,"").replace("\r",""));return r.reduce((m,b,T)=>(m[b]=v[T],m),{})})}const de=()=>{V.current.click()},ce=async t=>{const s=t.target.files[0];ae(s.name),I.onload=async r=>{const n=ie(r.target.result);n.pop(),console.log(n);const c=[],a=n.map(v=>{const $=`${R.baseURL}/api-proxy/proxy?method=get&resource=products&exact_match=true&name=${v.sku}`;return console.log($),z.get($,{headers:{Authorization:`Bearer ${L.get("jwt")}`}}).then(m=>{if(console.log(m.data.data),Array.isArray(m.data.data)&&m.data.data.length===0)alert(`There appears to be an issue with your CSV file. Please review and correct it. Product ${v.sku} not found.`);else{const b=m.data.data[0];b.category=b.categ_id.name,b.attributes=b.product_template_attribute_value_ids.map(T=>`${T.attribute}:${T.name}`),b.product_uom_qty=Number(v.qty),c.push(b)}}).catch(m=>{console.error("Error fetching products:",m)})});await Promise.all(a),console.log(`Total products fetched: ${c.length}`),c.length===n.length&&(console.log("Setting products"),console.log(c),U(c)),t.target.value=null},I.readAsText(s)},ue=(t,s)=>{console.log("Fetching order totals");const r=`${R.baseURL}/api-proxy/proxy?method=post&resource=ordertotals`;console.log(r);const n=x.map(a=>({product_id:a.id,product_uom_qty:a.product_uom_qty})),c={partner_id:o.id,order_line:n};console.log("Request body",c),z.post(r,c,{headers:{Authorization:`Bearer ${L.get("jwt")}`}}).then(a=>{console.log(a.data),Y(a.data.result.product_prices),ee(a.data.result.subtotal),re(a.data.result.total)}).catch(a=>{console.error("Error fetching order totals:",a)})};d.useEffect(()=>{ue();const t=x.reduce((s,r)=>s+r.product_uom_qty,0);oe(t)},[o,x]);const he=(t,s,r)=>{if(t<0||t>=x.length)return;const n=x.filter((c,a)=>a!==t);F(n)},pe=(t,s)=>{const r=x.map((n,c)=>{if(c===t){console.log(n),console.log(s);const a=["consu","service"];return n.qty_available<s&&!a.includes(n.type)?(alert("Quantity available is insufficient."),n):{...n,product_uom_qty:s!==0?Number(s):0}}return n});F(r)},P=t=>t?`$${t.toFixed(2)}`:"",xe=t=>{console.log("Setting order partner"),console.log(t),u({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email}),g({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""})},je=t=>{console.log("Setting order partner"),console.log(t),g({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email})},U=t=>{console.log("Adding order lines"),console.log(t);const s=["consu","service"];t.forEach(r=>{const n=x.some(c=>c.id===r.id);if(r.qty_available<1&&!s.includes(r.type)){alert(`Cannot add product lines with 0 qty available: SKU ${r.default_code}`);return}if(n){alert(`Product has already been added: SKU ${r.default_code}`);return}F(c=>[...c,{id:r.id,name:r.name,default_code:r.default_code,category:r.category,type:r.type,lst_price:r.lst_price,invoice_policy:r.invoice_policy,description_sale:r.description_sale,attributes:r.attributes,sale_ok:r.sale_ok,purchase_ok:r.purchase_ok,sales_count:r.sales_count,product_uom_qty:r.qty_needed||1,qty_available:r.qty_available}])})},me=t=>{se(t.target.value)},ye=t=>{le(t.target.value)},ge=()=>{p(!0),console.log("Creating an order");const t=`${R.baseURL}/api-proxy/proxy?method=post&resource=orders`;console.log(t),console.log(x);const s=x.map(n=>({product_id:n.id,product_uom_qty:n.product_uom_qty}));console.log(s);const r={order:{partner_id:o.id,order_line:s,x_studio_notes:B,client_order_ref:M,...l.id&&{partner_shipping_id:l.id}}};console.log("Request body",r),z.post(t,r,{headers:{Authorization:`Bearer ${L.get("jwt")}`}}).then(n=>{console.log(n.data),p(!1),y.push(`/orders/${n.data.result.sale_order_id}`)}).catch(n=>{console.error("Error fetching customers:",n)})},fe=e.jsxs(e.Fragment,{children:[e.jsx(D,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(C,{fullWidth:!0,name:"partner_id",label:"Customer",value:o.name,InputProps:{readOnly:!0,endAdornment:e.jsx(_,{children:e.jsx(H,{onSelect:xe})})}})}),o.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(i,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(i,{variant:"body1",children:o.street}),e.jsxs(i,{variant:"body1",children:[o.city," ",o.state]}),e.jsxs(i,{variant:"body1",children:[o.country," ",o.zip]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",o.phone]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",o.mobile]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",o.email]})]}),e.jsx("div",{style:{margin:"16px 0"}}),o.name&&e.jsx(D,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(C,{fullWidth:!0,name:"partner_shipping_id",label:"Delivery Address",value:l.name,InputProps:{readOnly:!0,endAdornment:e.jsx(_,{children:e.jsx(J,{onSelect:je,filterParentContactOption:o.id})})}})}),l.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(i,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(i,{variant:"body1",children:l.street}),e.jsxs(i,{variant:"body1",children:[l.city," ",o.state]}),e.jsxs(i,{variant:"body1",children:[l.country," ",o.zip]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",l.phone]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",l.mobile]}),e.jsxs(i,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",l.email]})]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(_,{children:e.jsx(K,{onSelect:U})}),e.jsx(_,{children:e.jsx(X,{onSelect:U})}),e.jsx("input",{type:"file",accept:".csv",onChange:ce,ref:V,style:{display:"none"}}),e.jsx(f,{variant:"contained",color:"primary",onClick:de,children:"Upload CSV"}),N&&e.jsxs(i,{variant:"body1",style:{marginTop:"10px"},children:["Selected file: ",N]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Te,{component:ve,children:e.jsxs(we,{children:[e.jsx(Oe,{children:e.jsxs(Q,{children:[e.jsx(h,{children:"Product"}),e.jsx(h,{children:"Attributes"}),e.jsx(h,{children:"Unit Price"}),e.jsx(h,{children:"Qty Available"}),e.jsx(h,{children:"Qty"}),e.jsx(h,{children:"Subtotal"}),e.jsx(h,{})]})}),e.jsx(qe,{children:x.map((t,s)=>e.jsxs(Q,{children:[e.jsxs(h,{children:["[",t.default_code,"] ",t.name]}),e.jsx(h,{children:t.attributes.map((r,n)=>e.jsx(ke,{label:r.name||r.attribute,variant:"outlined"},n))}),e.jsx(h,{children:P(E[t.id])}),e.jsx(h,{children:t.qty_available}),e.jsx(h,{children:e.jsx(C,{type:"number",style:{minWidth:"100px"},value:t.product_uom_qty!==0?t.product_uom_qty:"",onChange:r=>pe(s,r.target.value)})}),e.jsx(h,{children:P(E[t.id]*t.product_uom_qty)}),e.jsx(h,{align:"right",children:e.jsx(_,{onClick:()=>he(s),children:e.jsx(_e,{icon:"eva:trash-2-outline"})})})]},s))})]})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsxs(i,{variant:"body1",fontWeight:"bold",children:["Total Product Qty: ",ne]}),e.jsxs(i,{variant:"body1",fontWeight:"bold",children:["Subtotal: ",P(Z)]}),e.jsxs(i,{variant:"body1",fontWeight:"bold",children:["Total: ",P(te)]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(w,{container:!0,spacing:2,children:e.jsx(w,{item:!0,xs:12,md:6,lg:6,children:e.jsx(C,{label:"Notes",value:B,multiline:!0,fullWidth:!0,rows:4,onChange:me})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(w,{container:!0,spacing:2,children:e.jsx(w,{item:!0,xs:12,md:6,lg:6,children:e.jsx(C,{label:"PO Number",value:M,fullWidth:!0,onChange:ye})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Ae,{fullWidth:!0,size:"large",type:"submit",variant:"contained",color:"inherit",onClick:ge,loading:j,children:"Create"})]});return e.jsxs(We,{children:[e.jsx(D,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:5,children:e.jsx(i,{variant:"h4",children:"New Order"})}),fe,e.jsx(Fe,{})]})}function Je(){return Ue(),e.jsxs(e.Fragment,{children:[e.jsx(Ce,{children:e.jsx("title",{children:" New Order | BEX Sales "})}),e.jsx($e,{})]})}export{Je as default};
