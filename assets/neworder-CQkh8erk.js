import{r as d,j as e,D as b,P as q,C as fe,S as A,H as P,T as l,N as be,J as _e,E as k,F,G as W,W as ve}from"./index-CrQ_cH7N.js";import{D as $,a as D,b as R,P as Ce,c as U}from"./product-template-view-CH54AVVW.js";import{F as z,T as v}from"./TextField-BcsQvwiw.js";import{C as G}from"./customer-view-DowZOLbJ.js";import{e as Se,f as Pe,b as Te,T as V,a as u,g as qe}from"./search-fill-Br6OXajf.js";import{C as we}from"./Chip-BJvXCU4D.js";import{G as T}from"./Grid-Brtnl7Bz.js";import{L as Oe}from"./LoadingButton-CIsc6dwm.js";import{C as Ae}from"./Container-Bo6T3YIZ.js";import{C as ke}from"./Card-xykPG5M7.js";import{u as Fe}from"./use-auth-Ts08gJbQ.js";import"./Select-3JCclZm4.js";import"./isMuiElement-BEt_GLtU.js";function H({onSelect:j}){const[y,m]=d.useState(!1),o=()=>{m(!0)},p=()=>{m(!1)},i=g=>{j(g),p()};return e.jsxs("div",{children:[e.jsx(b,{variant:"outlined",onClick:o,children:"Add Product"}),e.jsxs($,{open:y,onClose:p,maxWidth:"xl",fullWidth:!0,children:[e.jsx(D,{children:"Products"}),e.jsx(R,{children:e.jsx(z,{sx:{width:"100%"},children:e.jsx(Ce,{onSelect:i,style:{width:"100%"}})})}),e.jsx(U,{children:e.jsx(b,{onClick:p,color:"primary",children:"Close"})})]})]})}H.propTypes={onSelect:q.func};function K({onSelect:j}){const[y,m]=d.useState(!1),o=()=>{m(!0)},p=()=>{m(!1)},i=g=>{j(g),p()};return e.jsxs("div",{children:[e.jsx(b,{variant:"outlined",onClick:o,children:"Set"}),e.jsxs($,{open:y,onClose:p,maxWidth:"xl",fullWidth:!0,children:[e.jsx(D,{children:"Customers"}),e.jsx(R,{sx:{padding:0},children:e.jsx(z,{sx:{width:"100%"},children:e.jsx(G,{onSelect:i,style:{width:"100%"}})})}),e.jsx(U,{children:e.jsx(b,{onClick:p,color:"primary",children:"Close"})})]})]})}K.propTypes={onSelect:q.func};function J({onSelect:j,filterParentContactOption:y}){const[m,o]=d.useState(!1),p=()=>{o(!0)},i=()=>{o(!1)},g=h=>{j(h),i()};return d.useEffect(()=>{console.log("DeliveryPopupModal Props:"),console.log("filterParentContactOption:",y)},[j,y]),e.jsxs("div",{children:[e.jsx(b,{variant:"outlined",onClick:p,children:"Set"}),e.jsxs($,{open:m,onClose:i,maxWidth:"xl",fullWidth:!0,children:[e.jsx(D,{children:"Delivery Address"}),e.jsx(R,{sx:{padding:0},children:e.jsx(z,{sx:{width:"100%"},children:e.jsx(G,{onSelect:g,filterTypeOption:"delivery",filterParentContactOption:y,style:{width:"100%"}})})}),e.jsx(U,{children:e.jsx(b,{onClick:i,color:"primary",children:"Close"})})]})]})}J.propTypes={onSelect:q.func,filterParentContactOption:q.number};function We(){const j=fe(),[y,m]=d.useState(!1),[o,p]=d.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[i,g]=d.useState({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""}),[h,w]=d.useState([]),[L,X]=d.useState({}),[Y,Z]=d.useState(0),[ee,te]=d.useState(0),[re,ne]=d.useState(0),[E,oe]=d.useState(""),[N,se]=d.useState(""),[B,ae]=d.useState(""),I=new FileReader,M=d.useRef(null);function le(t,s=","){let r=t.slice(0,t.indexOf(`
`)).split(s);return r=r.map(a=>a.replace(`
`,"").replace("\r","")),t.slice(t.indexOf(`
`)+1).split(`
`).map(a=>{const _=a.split(s).map(x=>x.replace(`
`,"").replace("\r",""));return r.reduce((x,f,S)=>(x[f]=_[S],x),{})})}const ie=()=>{M.current.click()},de=async t=>{const s=t.target.files[0];ae(s.name),I.onload=async r=>{const n=le(r.target.result);n.pop(),console.log(n);const c=[],a=n.map(_=>{const O=`${k.baseURL}/api-proxy/proxy?method=get&resource=products&exact_match=true&name=${_.sku}`;return console.log(O),F.get(O,{headers:{Authorization:`Bearer ${W.get("jwt")}`}}).then(x=>{if(console.log(x.data.data),Array.isArray(x.data.data)&&x.data.data.length===0)alert(`There appears to be an issue with your CSV file. Please review and correct it. Product ${_.sku} not found.`);else{const f=x.data.data[0];f.category=f.categ_id.name,f.attributes=f.product_template_attribute_value_ids.map(S=>`${S.attribute}:${S.name}`),f.product_uom_qty=Number(_.qty),c.push(f)}}).catch(x=>{console.error("Error fetching products:",x)})});await Promise.all(a),console.log(`Total products fetched: ${c.length}`),c.length===n.length&&(console.log("Setting products"),console.log(c),Q(c)),t.target.value=null},I.readAsText(s)},ce=(t,s)=>{console.log("Fetching order totals");const r=`${k.baseURL}/api-proxy/proxy?method=post&resource=ordertotals`;console.log(r);const n=h.map(a=>({product_id:a.id,product_uom_qty:a.product_uom_qty})),c={partner_id:o.id,order_line:n};console.log("Request body",c),F.post(r,c,{headers:{Authorization:`Bearer ${W.get("jwt")}`}}).then(a=>{console.log(a.data),X(a.data.result.product_prices),Z(a.data.result.subtotal),te(a.data.result.total)}).catch(a=>{console.error("Error fetching order totals:",a)})};d.useEffect(()=>{ce();const t=h.reduce((s,r)=>s+r.product_uom_qty,0);ne(t)},[o,h]);const ue=(t,s,r)=>{if(t<0||t>=h.length)return;const n=h.filter((c,a)=>a!==t);w(n)},he=(t,s)=>{const r=h.map((n,c)=>{if(c===t){console.log(n),console.log(s);const a=["consu","service"];return n.qty_available<s&&!a.includes(n.type)?(alert("Quantity available is insufficient."),n):{...n,product_uom_qty:s!==0?Number(s):0}}return n});w(r)},C=t=>t?`$${t.toFixed(2)}`:"",pe=t=>{console.log("Setting order partner"),console.log(t),p({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email}),g({id:0,name:"",street:"",city:"",state:"",country:"",zip:"",phone:"",mobile:"",email:""})},xe=t=>{console.log("Setting order partner"),console.log(t),g({id:t.id,name:t.name,street:t.street,city:t.city,state:t.state,country:t.country,zip:t.zip,phone:t.phone,mobile:t.mobile,email:t.email})},Q=t=>{console.log("Adding order lines"),console.log(t);const s=["consu","service"];t.forEach(r=>{const n=h.some(c=>c.id===r.id);if(r.qty_available<1&&!s.includes(r.type)){alert(`Cannot add product lines with 0 qty available: SKU ${r.default_code}`);return}if(n){alert(`Product has already been added: SKU ${r.default_code}`);return}w(c=>[...c,{id:r.id,name:r.name,default_code:r.default_code,category:r.category,type:r.type,lst_price:r.lst_price,invoice_policy:r.invoice_policy,description_sale:r.description_sale,attributes:r.attributes,sale_ok:r.sale_ok,purchase_ok:r.purchase_ok,sales_count:r.sales_count,product_uom_qty:r.qty_needed||1,qty_available:r.qty_available}])})},me=t=>{oe(t.target.value)},ye=t=>{se(t.target.value)},je=()=>{m(!0),console.log("Creating an order");const t=`${k.baseURL}/api-proxy/proxy?method=post&resource=orders`;console.log(t),console.log(h);const s=h.map(n=>({product_id:n.id,product_uom_qty:n.product_uom_qty}));console.log(s);const r={order:{partner_id:o.id,order_line:s,x_studio_notes:E,client_order_ref:N,...i.id&&{partner_shipping_id:i.id}}};console.log("Request body",r),F.post(t,r,{headers:{Authorization:`Bearer ${W.get("jwt")}`}}).then(n=>{console.log(n.data),m(!1),j.push(`/orders/${n.data.result.sale_order_id}`)}).catch(n=>{console.error("Error fetching customers:",n)})},ge=e.jsxs(e.Fragment,{children:[e.jsx(A,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(v,{fullWidth:!0,name:"partner_id",label:"Customer",value:o.name,InputProps:{readOnly:!0,endAdornment:e.jsx(P,{children:e.jsx(K,{onSelect:pe})})}})}),o.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(l,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(l,{variant:"body1",children:o.street}),e.jsxs(l,{variant:"body1",children:[o.city," ",o.state]}),e.jsxs(l,{variant:"body1",children:[o.country," ",o.zip]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",o.phone]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",o.mobile]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",o.email]})]}),e.jsx("div",{style:{margin:"16px 0"}}),o.name&&e.jsx(A,{spacing:3,direction:"row",alignItems:"center",children:e.jsx(v,{fullWidth:!0,name:"partner_shipping_id",label:"Delivery Address",value:i.name,InputProps:{readOnly:!0,endAdornment:e.jsx(P,{children:e.jsx(J,{onSelect:xe,filterParentContactOption:o.id})})}})}),i.name&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(l,{variant:"body1",fontWeight:"bold",children:"Address:"}),e.jsx(l,{variant:"body1",children:i.street}),e.jsxs(l,{variant:"body1",children:[i.city," ",o.state]}),e.jsxs(l,{variant:"body1",children:[i.country," ",o.zip]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Phone:"})," ",i.phone]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Mobile:"})," ",i.mobile]}),e.jsxs(l,{variant:"body1",children:[e.jsx("b",{children:"Email:"})," ",i.email]})]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(P,{children:e.jsx(H,{onSelect:Q})}),e.jsx("input",{type:"file",accept:".csv",onChange:de,ref:M,style:{display:"none"}}),e.jsx(b,{variant:"contained",color:"primary",onClick:ie,children:"Upload CSV"}),B&&e.jsxs(l,{variant:"body1",style:{marginTop:"10px"},children:["Selected file: ",B]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Se,{component:be,children:e.jsxs(Pe,{children:[e.jsx(Te,{children:e.jsxs(V,{children:[e.jsx(u,{children:"Product"}),e.jsx(u,{children:"Attributes"}),e.jsx(u,{children:"Unit Price"}),e.jsx(u,{children:"Qty Available"}),e.jsx(u,{children:"Qty"}),e.jsx(u,{children:"Subtotal"}),e.jsx(u,{})]})}),e.jsx(qe,{children:h.map((t,s)=>e.jsxs(V,{children:[e.jsxs(u,{children:["[",t.default_code,"] ",t.name]}),e.jsx(u,{children:t.attributes.map((r,n)=>e.jsx(we,{label:r.name||r.attribute,variant:"outlined"},n))}),e.jsx(u,{children:C(L[t.id])}),e.jsx(u,{children:t.qty_available}),e.jsx(u,{children:e.jsx(v,{type:"number",style:{minWidth:"100px"},value:t.product_uom_qty!==0?t.product_uom_qty:"",onChange:r=>he(s,r.target.value)})}),e.jsx(u,{children:C(L[t.id]*t.product_uom_qty)}),e.jsx(u,{align:"right",children:e.jsx(P,{onClick:()=>ue(s),children:e.jsx(_e,{icon:"eva:trash-2-outline"})})})]},s))})]})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsxs(l,{variant:"body1",fontWeight:"bold",children:["Total Product Qty: ",re]}),e.jsxs(l,{variant:"body1",fontWeight:"bold",children:["Subtotal: ",C(Y)]}),e.jsxs(l,{variant:"body1",fontWeight:"bold",children:["Total: ",C(ee)]}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(T,{container:!0,spacing:2,children:e.jsx(T,{item:!0,xs:12,md:6,lg:6,children:e.jsx(v,{label:"Notes",value:E,multiline:!0,fullWidth:!0,rows:4,onChange:me})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(T,{container:!0,spacing:2,children:e.jsx(T,{item:!0,xs:12,md:6,lg:6,children:e.jsx(v,{label:"PO Number",value:N,fullWidth:!0,onChange:ye})})}),e.jsx("div",{style:{margin:"16px 0"}}),e.jsx(Oe,{fullWidth:!0,size:"large",type:"submit",variant:"contained",color:"inherit",onClick:je,loading:y,children:"Create"})]});return e.jsxs(Ae,{children:[e.jsx(A,{direction:"row",alignItems:"center",justifyContent:"space-between",mb:5,children:e.jsx(l,{variant:"h4",children:"New Order"})}),ge,e.jsx(ke,{})]})}function Ge(){return Fe(),e.jsxs(e.Fragment,{children:[e.jsx(ve,{children:e.jsx("title",{children:" New Order | BEX Sales "})}),e.jsx(We,{})]})}export{Ge as default};
